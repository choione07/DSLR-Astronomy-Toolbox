# DSLR 망원경 천문학 툴박스 - 완전한 기술 문서

## 시스템 개요

DSLR 망원경 천문학 툴박스는 DSLR 망원경 촬영을 위해 특별히 설계된 천문 이미지 처리 및 측광 분석을 위한 포괄적인 Python 기반 솔루션입니다. 이 시스템은 원본 CR3 이미지 변환부터 과학적 데이터 시각화 및 내보내기 기능을 갖춘 전문 개구측광 분석까지 완전한 워크플로우를 제공합니다.

### 프로젝트 목적
- DSLR 망원경 이미지를 원본 형식에서 보정된 FITS 파일로 처리
- 변광성 및 천체에 대한 전문 개구측광 수행
- 과학적 정확도로 시간에 따른 별의 밝기 변화 추적
- 천문 연구 및 분석을 위한 출판 품질 데이터 내보내기
- 아마추어 및 전문 천문학자를 위한 통합 워크플로우 제공

### 대상 응용 분야
- 변광성 측광 및 모니터링
- 외계행성 통과 측광
- 소행성 밝기 측정
- 별 색상 분석 및 측광 연구
- 시계열 천문 데이터 수집
- DSLR 망원경 이미지 보정 및 처리

## 시스템 구성 요소

### 1. 메인 런처 (`main.py`)
**목적**: 모든 천문학 처리 도구의 주요 진입점 역할을 하는 통합 제어 센터.

**주요 기능**:
- 모든 천문학 도구를 위한 중앙 대시보드
- CR3부터 측광까지 단계별 워크플로우 안내
- 개별 도구 실행 기능
- 시스템 의존성 확인 및 검증
- 결과 폴더 및 문서에 빠른 액세스

**완전한 워크플로우**:
1. **원본 파일 변환**: CR3 → FITS 변환
2. **이미지 보정**: 바이어스/다크/플랫 보정
3. **측광 분석**: 별 측정 및 추적

### 2. 형식 변환기 (`convert.py`)
**목적**: Canon CR3 원본 파일을 천문 분석에 적합한 FITS 형식으로 변환.

**주요 기능**:
- **CR3를 흑백 FITS로**: 원본 센서 데이터 추출, 수직 뒤집기 적용
- **CR3를 RGB FITS로**: 16비트 출력 깊이로 3채널 RGB FITS 생성
- **RGB를 흑백으로 변환**: CIE 표준 계수를 사용한 가중 휘도
- **대화형 GUI 변환기**: 사용자 친화적인 배치 처리 인터페이스

**기술 사양**:
- 입력 형식: Canon CR3 원본 파일, RGB FITS 파일
- 출력 형식: 흑백 FITS, RGB FITS (3채널)
- 데이터 타입: 최대 동적 범위를 위한 16비트 정수
- 처리 속도: CR3 파일당 약 5-15초

### 3. 이미지 보정 시스템 (`calibration_gui.py`, `calibration.py`)
**목적**: DeepSkyStacker 방법론을 따르는 전문 천문 이미지 보정.

**주요 기능**:
- **마스터 프레임 생성**: 중앙값 스태킹을 사용하여 바이어스, 다크, 플랫 프레임 결합
- **라이트 프레임 보정**: 바이어스, 다크, 플랫 필드 보정 적용
- **대화형 보정 GUI**: 실시간 미리보기 및 진행 모니터링
- **품질 제어**: 문제가 있는 프레임 자동 감지

**보정 워크플로우** (표준 CCD 환원):
1. 바이어스 프레임 로드 → 마스터 바이어스 생성 (중앙값 결합)
2. 다크 프레임 로드 → 마스터 다크 생성 (중앙값 결합, 보정 불필요)
3. 플랫 프레임 로드 → 각 플랫 바이어스/다크 보정 → 마스터 플랫 생성 (중앙값 결합)
4. 라이트 프레임 로드 → 전체 보정 적용: (Light - Bias - Dark × scale) / Flat_normalized
5. 측광 준비가 된 보정된 FITS 파일 출력

**보정 공식**:
```
보정됨 = (원본 - 마스터바이어스 - 마스터다크 × 최적화계수) / 마스터플랫_정규화
```

여기서:
- 마스터플랫_정규화 = (마스터플랫 - 바이어스 - 다크) / mean(마스터플랫)
- 최적화계수: 선택적 노출 시간 스케일링 (기본값: 1.0)

**플랫 필드의 색상 균형**:
- 적절한 색상 균형을 유지하기 위해 각 RGB 채널 정규화
- 노이즈 증폭을 피하기 위해 최소 채널 평균을 기준으로 사용
- 보정된 이미지에서 체계적인 색상 편향 방지

### 4. FITS 이미지 뷰어 (`viewer.py`)
**목적**: 천문 데이터 시각화를 위한 전문 FITS 이미지 표시 도구.

**기능**:
- 자동 형식 감지 (흑백 vs RGB)
- 적절한 천문 방향
- 백분위수 기반 대비 스트레칭 (0.5-99.5%)
- 확대/이동 기능이 있는 대화형 기능
- 과학적 시각화 원칙

### 5. 개구측광 스위트 (`photometry.py`)
**목적**: 과학적 방법론을 구현하는 전문 개구측광 분석 시스템.

## 과학적 방법론

### 개구측광 구현
시스템은 천문학 모범 사례를 따르는 전문 개구측광을 구현합니다:

1. **강건한 하늘 배경 계산**:
   - 하늘 환형 픽셀에서 **시그마 클리핑된 중앙값** 사용 (σ=3.0, maxiters=10)
   - 우주선, 핫픽셀 및 이상치 자동 제거
   - `SigmaClip`이 있는 `photutils.ApertureStats`를 통해 구현
   - 단순 중앙값 또는 평균 방법보다 강건함

2. **별 플럭스 측정**:
   - 정밀한 배경 빼기를 사용한 원형 개구측광
   - 하늘 배경: 중앙값 × 개구_면적
   - 보정된 플럭스: 원본_플럭스 - 하늘_배경

3. **물리적으로 정확한 푸아송 노이즈 계산**:
   - 배경 빼기 전 **원본 광자 수** 사용: √N_raw
   - 광자 계수 통계의 물리적으로 정확한 표현
   - 과학 분석에서 적절한 오차 전파에 중요

4. **다중 채널 RGB 처리**:
   - 개별 R, G, B + 흑백 측광
   - 동일한 강건한 알고리즘으로 처리된 각 채널
   - 모든 채널에서 일관된 시그마 클리핑

### 알고리즘 개선 (v1.1)

**적용된 중요 수정:**

1. **RGB 측광 시그마 클리핑** (photometry.py:2160-2163)
   - **이전**: 하늘 픽셀에 단순 `np.median()` 사용
   - **이후**: 시그마 클리핑이 있는 `ApertureStats` 사용 (σ=3.0)
   - **영향**: 우주선 및 핫픽셀에 강건함

2. **푸아송 노이즈 계산** (photometry.py:2118, 2174, 2198)
   - **이전**: `√(보정된_플럭스)` - 수학적으로 부정확
   - **이후**: `√(원본_플럭스)` - 물리적으로 정확
   - **영향**: 과학 분석을 위한 적절한 불확실성 추정

3. **다크 프레임 최적화** (calibration.py:213-260)
   - **이전**: 스케일링 계수에 핫픽셀만 사용
   - **이후**: 시그마 클리핑된 중앙값으로 더 넓은 픽셀 선택 사용
   - **영향**: 더 안정적이고 신뢰할 수 있는 다크 빼기

4. **플랫 필드 보정** (calibration.py:580-632)
   - **이전**: 원본 플랫 프레임에서 마스터 플랫 생성
   - **이후**: 결합 전에 각 플랫 프레임 바이어스/다크 보정
   - **영향**: 표준 CCD 보정 절차 준수 - 중요 수정

### 처리 모드

**모드 1: 자동 추적**
- 사용자가 첫 번째 이미지에서 별 선택
- 시스템이 후속 이미지에서 별 중심점 자동 추적
- 밝기 검증이 있는 중심점 정제 사용
- 배경 스레딩으로 GUI 동결 방지

**모드 2: 수동 순차 (PASCO Capstone 스타일)**
- 프레임별 수동 별 선택
- 각 클릭 후 자동 프레임 진행
- 이전 별 위치에 자동 중심 맞추기
- 시퀀스 전체에서 확대 지속 유지

### 데이터 시각화 시스템

시스템에는 4개의 주요 탭이 있는 종합 분석 창(1600×1200 픽셀)이 포함됩니다:

**탭 1: 광도 곡선 분석**
- 결합된 RGB + 흑백 플럭스 추세
- 색상 코딩이 있는 RGB 채널 비교
- 원본 vs 하늘 보정 비교
- 신호 대 잡음비 추세

**탭 2: RGB 분석**
- RGB 채널 플럭스 비교
- 시간에 따른 색상 비율 (R/G, B/G, R/B)
- 천문 색상 지수 (B-V, V-R)
- 채널 노이즈 비교

**탭 3: 품질 메트릭**
- 시간에 따른 하늘 배경 변화
- 하늘 노이즈 (σ) 표준편차
- 푸아송 노이즈 (√N) 분석
- 모든 채널에 대한 총 S/N 비율

**탭 4: 추적 분석**
- 위치 이동 (시간에 따른 X,Y 좌표)
- 프레임당 이동 분석
- 시간 진행이 있는 2D 위치 산점도
- 추적 품질 평가

## 기술 사양

### 시스템 요구사항
- **Python**: 3.8+ (tkinter 지원 포함)
- **운영체제**: Windows, macOS, Linux
- **메모리**: 대용량 이미지 시퀀스에 4GB+ RAM 권장
- **디스플레이**: 최적의 GUI 경험을 위해 최소 1400×900 해상도

### 필수 의존성
```
astropy >= 5.0          # FITS 처리, 천문 계산
photutils >= 1.5.0      # 개구측광, 별 검출
matplotlib >= 3.5.0     # 시각화, GUI 통합
numpy >= 1.21           # 배열 연산, 수학 함수
scipy >= 1.7            # 통계 함수, 이미지 처리
rawpy                   # Canon CR3 원본 파일 처리
```

### 성능 특성
- **처리 속도**: 이미지당 약 1-5초
- **메모리 사용**: 약 50-100MB 기본 + 이미지 데이터
- **스레딩**: 배경 처리가 있는 논블로킹 GUI
- **디스플레이**: 하드웨어 가속 matplotlib 렌더링

### 개구 매개변수
- **별 개구**: 1-20 픽셀 (DSLR 이미지의 경우 일반적으로 3-8)
- **내부 하늘 반지름**: 1-20 픽셀 (일반적으로 12-20)
- **외부 하늘 반지름**: 1-20 픽셀 (일반적으로 20-30)
- **검출 감도**: 배경 위 0.5σ ~ 3.0σ
- **추적 허용 오차**: 프레임당 최대 12 픽셀 이동

## 데이터 출력

### CSV 내보내기 형식
**위치**: `./results/star_name_photometry_Nimages.csv`

**기본 열 (모든 이미지)**:
- `filename`, `image_index`, `star_name`, `is_rgb`
- `x_position`, `y_position`, `tracked_position`, `movement_pixels`
- `aperture_area`, `sky_annulus_area`

**RGB 이미지 (추가 열)**:
- R, G, B 채널: `*_star_flux_raw`, `*_flux_corrected`, `*_sky_background_total`, `*_sky_per_pixel`, `*_sky_std`, `*_poisson_noise`
- 흑백: 동일한 구조의 `gray_*` 측정

**FITS 메타데이터 (사용 가능한 경우)**:
- `fits_date-obs`, `fits_exptime`, `fits_filter`, `fits_telescop`
- `fits_instrume`, `fits_observer`, `fits_xpixsz`, `fits_ypixsz`

## 오류 처리 및 문제 해결

### 일반적인 문제 및 해결책

1. **"별이 감지되지 않음"**
   - 감도 슬라이더를 낮은 값(0.5σ - 1.0σ)으로 조정
   - 수동 배치를 위해 "개구 위치 조정" 모드 사용
   - 이미지 품질 및 대비 확인

2. **"이미지 N에서 추적 손실"**
   - 별이 희미하면 개구 크기 줄이기
   - 우주선 또는 이미지 아티팩트 확인
   - 대신 수동 순차 모드 사용

3. **"이미지가 표시되지 않음"**
   - "디스플레이 새로 고침" 버튼 사용
   - FITS 파일 형식 및 무결성 확인
   - 디스플레이 시스템 실패 시 애플리케이션 재시작

4. **"처리가 조기에 중지됨"**
   - 개별 이미지 품질 확인
   - 시퀀스에서 손상된 FITS 파일 찾기
   - 충분한 디스크 공간 및 메모리 확인

### 디버깅 기능
- 상태 창에 종합 로깅
- 모든 작업에 대한 타임스탬프가 있는 디버그 메시지
- 이미지별 업데이트로 진행 추적
- 특정 실패 설명이 있는 오류 메시지
- 복구 가능한 오류 후 처리 계속

## 과학적 응용

### 연구 응용
- **변광성 연구**: 세페이드 변광성, Delta Scuti, RR Lyrae 연구
- **외계행성 연구**: 행성 통과 측광 및 타이밍 변화
- **태양계 천문학**: 소행성 자전 주기, 혜성 밝기 모니터링
- **별 측광**: 다색 분석, 색-등급 도표
- **교육 응용**: 대학 실습 연습, 아마추어 천문학 프로젝트

### 전문 연구
- 동료 검토 저널을 위한 출판 품질 데이터
- 장기 모니터링 프로그램
- 탐사 천문학 및 데이터 마이닝
- 우주 망원경 관측을 위한 지상 기반 지원

## 품질 보증

### 과학적 정확도 기능
- **방법론 준수**: 한국 천문학 텍스트 방법의 정확한 구현
- **통계적 강건성**: 중앙값 결합 및 시그마 클리핑 통계
- **다중 방법 검출**: 강건한 별 검출을 위한 대체 알고리즘
- **밝기 검증**: 실제 별에 대한 측정 보장
- **오차 전파**: 적절한 불확실성 계산 및 보고

### 검증 기능
- 신호 대 잡음 모니터링
- 배경 안정성 추적
- 추적 품질 메트릭
- 색상 일관성 검증

## 코드 아키텍처

### 설계 원칙
- **모듈식 아키텍처**: 잘 분리된 GUI 및 처리 로직
- **스레드 안전성**: GUI 차단 없는 배경 처리
- **오류 복원력**: 개별 실패의 우아한 처리
- **확장 가능한 설계**: 새로운 분석 기능의 쉬운 추가
- **전문 표준**: 프로덕션 품질 오류 처리 및 로깅

### 주요 구성 요소
- **GUI 관리**: matplotlib 통합이 있는 tkinter
- **이미지 처리**: astropy 및 photutils 통합
- **데이터 시각화**: 과학적 형식이 있는 matplotlib
- **파일 관리**: 오류 복구가 있는 강건한 I/O
- **스레딩 시스템**: 진행 업데이트가 있는 배경 처리

## 향후 개선 가능성

### 잠재적 개선 사항
- **다중 별 측광**: 여러 대상 동시 처리
- **PSF 측광**: 혼잡한 필드를 위한 점 확산 함수 피팅
- **자동 보정**: 통합 보정 프레임 처리
- **기준 별 선택**: 자동 비교 별 식별
- **광도 곡선 모델링**: 내장 주기 분석 및 곡선 피팅

### 분석 개선
- 통계 분석 및 추세 감지
- 색-등급 도표 생성
- 변광성 검출 및 분류
- 푸리에 변환을 사용한 주기 분석
- 대기 소광 보정

## 결론

DSLR 망원경 천문학 툴박스는 천문 측광 분석을 위한 완전한 전문가급 솔루션을 나타냅니다. 엄격한 과학적 방법론과 직관적인 사용자 인터페이스 설계를 결합하여 연구자와 아마추어 천문학자에게 출판 품질의 결과를 제공합니다.

**주요 강점**:
- **과학적 정확성**: 적절한 개구측광 방법론 구현
- **전문 인터페이스**: 불필요한 복잡성이 없는 깔끔하고 직관적인 디자인
- **종합 분석**: 이미지 로딩부터 데이터 시각화까지 완전한 워크플로우
- **강건한 성능**: 천문 데이터의 실제 과제 처리
- **확장 가능한 설계**: 향후 개선 및 사용자 정의 준비

이 애플리케이션은 복잡한 천문학 소프트웨어와 사용자 친화적인 분석 도구 간의 격차를 성공적으로 해소하여 과학 연구에 필요한 엄격함을 유지하면서 더 넓은 커뮤니티가 정밀 측광에 액세스할 수 있도록 합니다.

## 버전 기록

### v1.1 (2025년 11월) - 중요 알고리즘 수정
**개구측광 개선:**
- RGB 측광을 시그마 클리핑 배경 통계를 사용하도록 수정
- 푸아송 노이즈 계산 수정 (이제 원본 카운트 사용)
- 두 수정 모두 과학적 정확성과 강건성 보장

**보정 시스템 개선:**
- 적절한 바이어스/다크 보정을 포함하도록 플랫 필드 생성 수정
- 강건한 통계를 사용한 개선된 다크 프레임 최적화 알고리즘
- 표준 CCD 보정 절차 준수

**영향:** 이러한 수정은 정확한 측광 측정에 중요하며 모든 기존 설치에 적용해야 합니다.

### v1.0 (2024년 9월) - 초기 릴리스
- 완전한 CR3에서 FITS로 변환 파이프라인
- 전체 이미지 보정 시스템
- 추적이 있는 전문 개구측광
- 종합 데이터 시각화
- 다중 채널 RGB 및 흑백 지원

---
*문서 버전: 완전한 기술 참조 v1.1*
*최종 업데이트: 2025년 11월*
*전체 시스템: 14개 Python 파일, 약 5500+ 줄의 코드*
